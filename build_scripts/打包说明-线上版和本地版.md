# 织梦AI - 线上版和本地版打包说明

## 概述

项目支持两种打包方式：
- **线上版**：轻量级Python环境，不包含TTS引擎（约100-200MB）
- **本地版**：完整TTS环境（约9.5GB）

两个版本的目录结构完全相同，可以互相替换和升级。

---

## 一、准备线上版Python环境

### 1. 运行环境安装脚本

```bash
cd build_scripts
setup_app_env.bat
```

这个脚本会：
- 在 `_internal_app\installer_files\env` 创建虚拟环境
- 安装主程序所需的依赖包（gradio、requests等）
- 验证环境是否正常

### 2. 测试环境

安装完成后，测试一下环境是否能运行主程序：

```bash
_internal_app\installer_files\env\Scripts\python.exe unified_app.py
```

如果能正常启动，说明环境配置成功。

---

## 二、打包线上版

### 1. 修改打包配置

编辑 `build_scripts\setup_zhimengai.iss`，找到第 32 行：

```ini
#define PackageType    "ONLINE"
```

确保设置为 `"ONLINE"`。

### 2. 运行打包脚本

```bash
cd build_scripts
build_package.bat
```

### 3. 输出文件

生成的安装包：`dist\ZhiMoAI_v2.0_Online_Setup.exe`

---

## 三、打包本地版

### 1. 修改打包配置

编辑 `build_scripts\setup_zhimengai.iss`，找到第 32 行：

```ini
#define PackageType    "LOCAL"
```

改为 `"LOCAL"`。

### 2. 运行打包脚本

```bash
cd build_scripts
build_package.bat
```

### 3. 输出文件

生成的安装包：`dist\ZhiMoAI_v2.0_Local_Setup.exe`

**注意**：本地版打包时间会很长（约10-30分钟），因为要压缩9.5GB的文件。

---

## 四、目录结构说明

### 线上版结构
```
_internal_app/
└── installer_files/
    └── env/              # 轻量级Python环境
        ├── python.exe
        ├── Scripts/
        ├── Lib/
        └── ...
```

### 本地版结构
```
_internal_tts/
├── installer_files/
│   └── env/              # 完整Python环境 + TTS依赖
│       ├── python.exe
│       ├── Scripts/
│       ├── Lib/
│       └── ...
├── webui.py
├── requirements.txt
└── ...
```

### 打包后的安装目录
```
C:\Program Files\ZhiMoAI\
├── app_backend.pyc
├── unified_app.pyc
├── libs/
├── ui/
├── _internal_tts/        # 无论哪个版本，都安装到这里
│   └── installer_files/
│       └── env/
└── ...
```

---

## 五、版本升级和切换

### 从线上版升级到本地版

1. 客户已安装线上版
2. 提供本地版安装包或 `_internal_tts` 压缩包
3. 客户运行安装包，会自动覆盖 `_internal_tts` 目录
4. 或者客户手动解压 `_internal_tts` 到安装目录

### 从本地版降级到线上版

1. 删除 `C:\Program Files\ZhiMoAI\_internal_tts`
2. 安装线上版，会重新创建轻量级环境

---

## 六、依赖包列表

### 线上版依赖（setup_app_env.bat）
- gradio
- requests
- python-dotenv
- Pillow
- opencv-python
- numpy
- pycryptodome
- websockets
- aiohttp

### 本地版额外依赖
- torch
- torchaudio
- transformers
- 其他TTS相关库（在 `_internal_tts\requirements.txt` 中）

---

## 七、常见问题

### Q1: 线上版能否使用TTS功能？
A: 不能。线上版只包含基础Python环境，TTS功能需要本地版或单独安装TTS环境。

### Q2: 如何减小本地版安装包大小？
A: 可以考虑：
1. 不打包本地版，让客户单独下载 `_internal_tts` 压缩包
2. 使用外部下载器（如百度网盘、阿里云盘）分发大文件
3. 制作增量更新包

### Q3: 两个版本的代码有区别吗？
A: 没有区别。代码完全相同，只是Python环境不同。

### Q4: 客户如何知道自己安装的是哪个版本？
A: 可以在程序启动时检测 `_internal_tts` 目录的大小：
- 小于 500MB = 线上版
- 大于 5GB = 本地版

---

## 八、维护建议

1. **定期更新依赖**：每次发布前检查依赖包是否有安全更新
2. **测试两个版本**：确保线上版和本地版都能正常运行
3. **文档同步**：更新依赖时同步更新 `setup_app_env.bat`
4. **版本号管理**：在安装包文件名中体现版本类型（已实现）

---

## 九、自动化脚本

### 一键打包两个版本（可选）

创建 `build_both_versions.bat`：

```batch
@echo off
echo 正在打包线上版...
REM 修改 setup_zhimengai.iss 中的 PackageType 为 ONLINE
call build_package.bat

echo.
echo 正在打包本地版...
REM 修改 setup_zhimengai.iss 中的 PackageType 为 LOCAL
call build_package.bat

echo.
echo 两个版本打包完成！
pause
```

---

## 联系方式

如有问题，请联系开发团队。
