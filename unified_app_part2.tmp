

def auto_load_model():
    global tts
    model_dir = os.path.join(INDEXTTS_DIR, "checkpoints")
    if not os.path.exists(model_dir):
        print("[ERR] model dir not found: " + model_dir)
        return
    for f in ["bpe.model", "gpt.pth", "config.yaml", "s2mel.pth", "wav2vec2bert_stats.pt"]:
        if not os.path.exists(os.path.join(model_dir, f)):
            print("[ERR] missing: " + f)
            return
    original_cwd = os.getcwd()
    os.chdir(INDEXTTS_DIR)
    try:
        print("[MODEL] Loading IndexTTS2...")
        from indextts.infer_v2 import IndexTTS2
        tts = IndexTTS2(
            model_dir=model_dir,
            cfg_path=os.path.join(model_dir, "config.yaml"),
            use_fp16=True,
        )
        print("[MODEL] OK (v" + str(tts.model_version or "1.0") + ")")
    except Exception as e:
        print("[MODEL] FAIL: " + str(e))
        traceback.print_exc()
    finally:
        os.chdir(original_cwd)


def generate_speech(
    text, prompt_audio,
    emo_mode, emo_audio, emo_weight,
    vec1, vec2, vec3, vec4, vec5, vec6, vec7, vec8,
    progress=gr.Progress()
):
    global tts
    if tts is None:
        raise gr.Error("Model not loaded!")
    if not text or not text.strip():
        raise gr.Error("Please input text!")
    if prompt_audio is None:
        raise gr.Error("Please upload reference audio!")
    timestamp = int(time.time())
    output_path = os.path.join(OUTPUT_DIR, "tts_" + str(timestamp) + ".wav")
    original_cwd = os.getcwd()
    os.chdir(INDEXTTS_DIR)
    try:
        tts.gr_progress = progress
        progress(0.1, desc="Synthesizing...")
        kwargs = {
            "do_sample": True, "top_p": 0.8, "top_k": 30, "temperature": 0.8,
            "length_penalty": 0.0, "num_beams": 3, "repetition_penalty": 10.0,
            "max_mel_tokens": 1500,
        }
        emo_ref = None
        vec = None
        if emo_mode == "\u4f7f\u7528\u60c5\u611f\u53c2\u8003\u97f3\u9891" and emo_audio:
            emo_ref = emo_audio
        elif emo_mode == "\u4f7f\u7528\u60c5\u611f\u5411\u91cf\u63a7\u5236":
            vec = [vec1, vec2, vec3, vec4, vec5, vec6, vec7, vec8]
            vec = tts.normalize_emo_vec(vec, apply_bias=True)
        tts.infer(
            spk_audio_prompt=prompt_audio, text=text, output_path=output_path,
            emo_audio_prompt=emo_ref, emo_alpha=emo_weight, emo_vector=vec,
            use_emo_text=False, **kwargs
        )
        os.chdir(original_cwd)
        progress(1.0, desc="Done")
        return output_path, "\u2705 Done!", output_path
    except Exception as e:
        os.chdir(original_cwd)
        traceback.print_exc()
        raise gr.Error("TTS failed: " + str(e))
